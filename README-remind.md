# 客户跟进超期提醒功能说明

## 功能概述

系统已实现完整的客户跟进超期提醒功能，能够根据用户配置的不同意向等级的天数来自动发送邮件提醒。

## 🔄 系统改造需求（2025年1月）

### 改造背景
- **问题**: 客户量从少量增长到巨大规模，无法对所有线索都进行跟进
- **现状**: 所有录入线索都自动进入跟进周期，导致跟进任务过载
- **目标**: 改为"按需跟进"模式，用户手动选择重要线索进行跟进

### 改造方案
#### 1. 数据库结构改造
- **新增字段**: `enable_followup` (是否启用跟进)
  - `0`: 不启用跟进（默认状态，不参与自动跟进流程）
  - `1`: 启用跟进（手动标记后，参与完整跟进流程）

#### 2. 业务逻辑改造
- **录入阶段**: 新线索默认 `enable_followup=0`，不创建跟进记录
- **手动控制**: 提供API接口启用/禁用线索跟进
- **定时检查**: 只检查 `enable_followup=1` 的线索
- **跟进逻辑**: 启用跟进的线索完全遵循现有跟进周期

#### 3. 新增API接口
- `PUT /api/leads/:id/enable-followup` - 启用线索跟进
- `PUT /api/leads/:id/disable-followup` - 禁用线索跟进

#### 4. 改造后的业务流程
```
线索录入 → enable_followup=0（默认不启用）
    ↓
用户手动决定 → 调用API设置 enable_followup=1
    ↓
启用跟进 → 创建首次跟进记录 → 进入完整跟进周期
    ↓
定时检查 → 只检查 enable_followup=1 的线索
```

### 改造优势
1. **灵活控制**: 用户可根据实际情况选择跟进线索
2. **减少干扰**: 避免大量不必要的跟进提醒
3. **提高效率**: 专注于重要客户的跟进
4. **保持完整**: 启用跟进的线索享受完整的自动跟进服务

### 改造实施状态
#### ✅ 已完成
1. **数据库结构**: 已添加 `enable_followup` 字段
2. **数据模型**: 已更新 `models/leadModel.js`
3. **线索创建**: 已修改创建逻辑，默认不启用跟进

#### 🔄 进行中
4. **控制器接口**: 正在添加启用/禁用跟进接口
5. **定时检查**: 需要修改跟进提醒服务逻辑
6. **路由配置**: 需要添加新的API路由

#### ⏳ 待完成
7. **测试验证**: 需要测试改造后的功能
8. **文档更新**: 需要更新API文档

## 功能特性

### 1. 自动定时检查
- **执行时间**: 每天上午9点自动执行
- **检查内容**: 根据配置的天数检查所有线索的跟进情况
- **提醒方式**: 自动发送邮件给配置的收件人列表

### 2. 意向等级配置
- **高意向**: 默认1天未跟进即提醒
- **中意向**: 默认3天未跟进即提醒  
- **低意向**: 默认5天未跟进即提醒
- **可自定义**: 每个等级的天数都可以单独配置

### 3. 邮件提醒功能
- **收件人管理**: 支持配置多个收件人邮箱
- **邮件内容**: 按意向等级分组显示超期线索
- **详细信息**: 包含客户昵称、跟进人、最后跟进时间、超期天数等

## 配置步骤

### 1. 配置邮件服务
在 `.env` 文件中配置邮件服务信息：
```
EMAIL_HOST=smtp.163.com
EMAIL_PORT=465
EMAIL_USER=your-email@163.com
EMAIL_PASS=your-password
EMAIL_FROM=your-email@163.com
```

### 2. 配置收件人邮箱
使用API接口添加收件人邮箱：
```bash
POST /api/remind-email-list
{
  "email": "recipient@example.com"
}
```

### 3. 配置提醒天数
使用API接口配置各意向等级的提醒天数：
```bash
# 配置高意向提醒天数
PUT /api/followup-remind-config/高
{
  "interval_days": 1
}

# 配置中意向提醒天数
PUT /api/followup-remind-config/中
{
  "interval_days": 3
}

# 配置低意向提醒天数
PUT /api/followup-remind-config/低
{
  "interval_days": 5
}
```

## API接口

### 跟进控制接口（新增）
```bash
# 启用线索跟进
PUT /api/leads/:id/enable-followup
Authorization: Bearer <token>

# 禁用线索跟进
PUT /api/leads/:id/disable-followup
Authorization: Bearer <token>
```

### 提醒配置接口
```bash
# 获取提醒配置
GET /api/followup-remind-config

# 更新提醒配置
PUT /api/followup-remind-config/:level
{
  "interval_days": 3
}

# 手动触发检查
POST /api/followup-remind-config/trigger-check
```

### 收件人邮箱管理
```bash
# 获取收件人列表
GET /api/remind-email-list

# 添加收件人
POST /api/remind-email-list
{
  "email": "new@example.com"
}

# 删除收件人
DELETE /api/remind-email-list/:id
```

## 测试功能

### 1. 运行测试脚本
```bash
node test-remind.js
```

### 2. 手动触发检查
```bash
curl -X POST http://localhost:3000/api/followup-remind-config/trigger-check
```

## 邮件内容示例

系统发送的邮件包含以下信息：
- 按意向等级分组的超期线索
- 每个线索的详细信息（客户昵称、跟进人、最后跟进时间、超期天数）
- 清晰的表格格式展示
- 支持HTML和纯文本格式

## 注意事项

### 改造后重要说明
1. **默认状态**: 新录入的线索默认不启用跟进（`enable_followup=0`）
2. **手动启用**: 需要手动调用API启用线索跟进才会开始自动提醒
3. **存量数据**: 现有线索默认保持不启用跟进状态，需要手动启用
4. **跟进逻辑**: 只有启用跟进的线索才会参与定时检查和邮件提醒

### 系统配置
1. **收件人配置**: 必须至少配置一个收件人邮箱才能发送邮件
2. **邮件服务**: 确保邮件服务配置正确，建议使用163邮箱或QQ邮箱
3. **定时执行**: 系统启动后会自动设置定时任务，每天上午9点执行
4. **手动触发**: 可以通过API接口手动触发检查，用于测试或紧急情况
5. **日志记录**: 所有检查结果和邮件发送状态都会记录在控制台日志中

## 故障排除

### 1. 邮件发送失败
- 检查邮件服务配置是否正确
- 确认邮箱密码是否为授权码（不是登录密码）
- 检查网络连接是否正常

### 2. 没有收到提醒邮件
- 确认是否配置了收件人邮箱
- 检查是否有超期线索
- 查看控制台日志确认检查是否正常执行

### 3. 定时任务不执行
- 确认服务器时间是否正确
- 检查应用是否正常运行
- 查看启动日志确认定时任务是否已启动 